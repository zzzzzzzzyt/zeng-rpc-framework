# æ‰‹å†™RPCæ¡†æ¶

![img](https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fb-ssl.duitang.com%2Fuploads%2Fitem%2F201604%2F05%2F20160405105346_hZKdw.png&refer=http%3A%2F%2Fb-ssl.duitang.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1653394602&t=1243d76abe126c9f3e6417bbfaf3bee2)



==**ç½—æ›¼-ç½—å…°è¯´è¿‡çš„ï¼Œè¿™ä¸ªä¸–ä¸Šåªæœ‰ä¸€ç§çœŸæ­£çš„è‹±é›„ä¸»ä¹‰ï¼Œé‚£å°±æ˜¯è®¤æ¸…ç”Ÿæ´»çš„çœŸç›¸ï¼Œå¹¶ä¸”ä»ç„¶çƒ­çˆ±å®ƒã€‚**==



## RPCæ¶æ„



![1650802303310](images/æ¶æ„å›¾.png)



## æŠ€æœ¯é€‰å‹



### **ç½‘ç»œä¼ è¾“ï¼š**

**ï¼ˆä¸ºäº†è°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œå°±æ˜¯éœ€è¦å‘é€ç½‘ç»œè¯·æ±‚æ¥ä¼ é€’ç›®æ ‡ç±»å’Œæ–¹æ³•ä¿¡æ¯ä»¥åŠæ–¹æ³•çš„å‚æ•°åˆ°æœåŠ¡æä¾›æ–¹ï¼‰**

- **bio**

- **nio**

- **netty**

### **åºåˆ—åŒ–ï¼š**

**ï¼ˆç¼–å†™ç½‘ç»œåº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œå› ä¸ºæ•°æ®åœ¨ç½‘ç»œä¸­ä¼ è¾“çš„éƒ½æ˜¯äºŒè¿›åˆ¶å­—èŠ‚ç æ•°æ®ï¼Œåœ¨å‘é€æ•°æ®æ—¶éœ€è¦ç¼–ç ï¼Œåœ¨æ¥æ”¶æ•°æ®æ—¶éœ€è¦è§£ç ï¼‰**

- **javaè‡ªå¸¦çš„åºåˆ—åŒ–**ï¼ˆä¹‹å‰ä½¿ç”¨è¿‡ è¿™ä¸ªçš„è¯ï¼Œä¸æ”¯æŒè·¨è¯­è¨€å¹³å° åŒæ—¶æ€§èƒ½æ¯”è¾ƒå·®  åºåˆ—åŒ–åçš„ä½“ç§¯æ¯”è¾ƒå¤§ï¼‰
- **kyro**
- **protobuf**ï¼ˆå°è¯•ä½¿ç”¨è¿™ä¸ªè¿›è¡Œï¼‰

### ä»£ç†ï¼š

**ï¼ˆä¸€å¼€å§‹æˆ‘ä¹Ÿä¸çŸ¥é“ä»£ç†æœ‰ä»€ä¹ˆç”¨ï¼Œç›´æ¥æŠŠä¸šåŠ¡é€»è¾‘ä»£ç å†™åœ¨é‚£è¾¹ä¸å°±è¡Œäº†å—ï¼Œä½†æ˜¯åé¢å¬äº†éŸ©é¡ºå¹³è€å¸ˆçš„è¯¾åå‘ç°ï¼ŒåŠ¨æ€ä»£ç†çš„ç›®çš„å°±æ˜¯è®©å¯¹è±¡èƒ½åƒè°ƒç”¨è‡ªå·±æ–¹æ³•ä¸€æ ·ï¼Œè°ƒç”¨è¿œç«¯çš„æ–¹æ³•ï¼Œç›¸å½“äºå¯¹äºæœåŠ¡è°ƒç”¨è€…æ˜¯ä¸€ä¸ªé»‘ç›’çš„çŠ¶æ€ï¼‰**

- **é™æ€ä»£ç†**
- **åŠ¨æ€ä»£ç†JDK**
- **åŠ¨æ€ä»£ç†Cglib**

### **æ³¨å†Œä¸­å¿ƒï¼š**

**ï¼ˆæœåŠ¡ç«¯å¯åŠ¨çš„æ—¶å€™å°†æœåŠ¡å+æœåŠ¡åœ°å€+æœåŠ¡ç«¯å£æ³¨å†Œ ç„¶åå®¢æˆ·ç«¯è¿›è¡Œè°ƒç”¨çš„æ—¶å€™ å°±é€šè¿‡æŸ¥åˆ°ç›¸åº”æœåŠ¡çš„åœ°å€è¿›è¡Œè°ƒç”¨--ç›¸å½“äºç›®å½•ï¼‰**

- **zookeeper**ï¼ˆè¯•è¯•æ”¾åœ¨linuxçš„dockeré‡Œç©ä¸‹ï¼‰ï¼ˆç”¨zookeeperå’Œcuratoråˆ†åˆ«æ¥å®ç°  æ³¨å†Œä¸­å¿ƒï¼‰
  
  - ç›®çš„åœ¨ä¸€å°è™šæ‹Ÿæœºä¸­è£…å¤šä¸ªå¸¦zookeeperçš„centosé•œåƒï¼Œè¿™æ ·å°±ä¸ç”¨å¯åŠ¨è¿‡å¤šçš„è™šæ‹Ÿæœºäº†ã€‚è¿™æ˜¯åè¯ï¼Œç›®å‰æ¥è¯´å¹¶ä¸éœ€è¦é›†ç¾¤ï¼Œå…ˆéƒ½æ³¨å†Œåˆ°ä¸€ä¸ªzookeeperä¸Š
    
  - `zookeeperçš„å®‰è£…`ï¼Œå¯ä»¥ç›´æ¥åœ¨linuxä¸‹å®‰è£…ï¼Œæˆ‘é€‰æ‹©åœ¨linuxçš„dockerä¸‹å®‰è£…ï¼Œä»¥ä¸‹æ˜¯å®‰è£…æ­¥éª¤ï¼ˆæš‚æ—¶æ²¡æœ‰ç”¨åˆ°é›†ç¾¤éƒ¨ç½²æ‰€ä»¥ä¸å¯¹å…¶é…ç½®è¿›è¡Œä¿®æ”¹ï¼‰
  
    ```shell
    #æ‹‰å–æœ€æ–°ç‰ˆzookeeperé•œåƒ  
    [root@zytCentos ~]# docker pull zookeeper
    Using default tag: latest
    latest: Pulling from library/zookeeper
    1fe172e4850f: Pull complete 
    44d3aa8d0766: Pull complete 
    fda2f211fa11: Pull complete 
    9154e8aefca7: Pull complete 
    692fa00e9b62: Pull complete 
    a17c9a9b7c3c: Pull complete 
    bd7073bfcd08: Pull complete 
    0e2c8094a504: Pull complete 
    Digest: sha256:1e62d091501c7125293c087414fccff4337c08d203b92988f4d88081b4f1f63e
    Status: Downloaded newer image for zookeeper:latest
    docker.io/library/zookeeper:latest
    ```
  
  - `zookeeperçš„è¿è¡Œ`
    ä¿æŒzookeeperçš„å¼€å¯çŠ¶æ€ï¼Œç”±äºæˆ‘ä¹‹å‰å¯åŠ¨æ²¡æœ‰åŠ -dæ‰€ä»¥åœ¨æ‰§è¡Œè¿æ¥å®ƒçš„å‘½ä»¤æ—¶æ€»ä¼šè‡ªåŠ¨å…³é—­ï¼ŒåŠ äº†çš„ç›®çš„æ˜¯ä¿è¯å®ƒèƒ½ä¿æŒåå°è¿è¡Œï¼Œ--restart alwaysè¿™ä¸ªæŒ‡ä»¤çš„ç›®çš„å°±æ˜¯ä¹‹åä¸ç”¨æ¯æ¬¡éƒ½å†å¯åŠ¨äº†
  
    ```shell
    [root@zytCentos ~]# docker run -d -p 2181:2181 --name zytzookeeper --restart always zookeeper
    ```
  
  - å°è¯•ç”¨æœ¬åœ°ideaè¿æ¥å¯åŠ¨çš„æœåŠ¡ç«¯
  
    - æ·»åŠ ä¾èµ– zookeeperåŸç”Ÿå®¢æˆ·ç«¯å’Œä¸€ä¸ªæ›´åŠ ä¾¿æ·å¼€å‘çš„å®¢æˆ·ç«¯Curator
  
      ```java
              <!--Zookeeperçš„ä¾èµ– å®¢æˆ·ç«¯-->
              <dependency>
                  <groupId>org.apache.zookeeper</groupId>
                  <artifactId>zookeeper</artifactId>
                  <version>3.5.7</version>
              </dependency>
              <!--é¡ºå¸¦å¼•å…¥çš„æ›´ä¾¿æ·æ“ä½œçš„curatorçš„ä¾èµ– Curatoræ˜¯Netflixå…¬å¸å¼€æºçš„ä¸€ä¸ªZookeeperå®¢æˆ·ç«¯ ç®€åŒ–äº†åŸç”Ÿçš„å¼€å‘-->
              <dependency>
                  <groupId>org.apache.curator</groupId>
                  <artifactId>curator-framework</artifactId>
                  <version>4.3.0</version>
              </dependency>
              <dependency>
                  <groupId>org.apache.curator</groupId>
                  <artifactId>curator-recipes</artifactId>
                  <version>4.3.0</version>
              </dependency>
              <dependency>
                  <groupId>org.apache.curator</groupId>
                  <artifactId>curator-client</artifactId>
                  <version>4.3.0</version>
              </dependency>
      ```
  
    - è¿›è¡Œæµ‹è¯•å¼€å‘ æ˜¯å¦æœ‰æ•ˆ
      é¦–å…ˆå‰ææˆ‘ä¸ºäº†æ–¹ä¾¿èµ·è§è®¾ç½®äº†åŸŸåæ˜ å°„ï¼ˆæƒ³å·æ‡’çš„å°ä¼™ä¼´å¯ä»¥å°è¯•ï¼‰
  
      ![1651124247792](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\1651124247792.png)
  
      ![1651124289654](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\1651124289654.png)
  
      `æ¥ä¸‹æ¥å°±æ˜¯å°è¯•å»è¿æ¥äº† `
  
      ![1651131030427](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\1651131030427.png)
  
      `åˆ›å»ºæˆåŠŸ`
  
      ![1651127726360](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\1651127726360.png)
  
      `æµ‹è¯•æˆåŠŸ` è¿›è¡Œè®¾ç½®
  
      
  
- **nacos**

  - a











### **ä¼ è¾“åè®®ï¼š**

**ï¼ˆä¼ è¾“åè®®çš„ä½œç”¨ å°±æ˜¯æˆ‘ä»¬å‘é€çš„ä¿¡æ¯ è¦æŒ‰ç…§æˆ‘ä»¬è‡ªå·±çš„è§„å®šæ„é€  ç›¸å½“äºå¯†æ–‡ä¼ è¾“çš„æ„Ÿè§‰ è®©åˆ«äººä¸çŸ¥é“åœ¨å‘é€ä»€ä¹ˆ ï¼‰**

- 

### **è´Ÿè½½å‡è¡¡ï¼š**

**ï¼ˆé˜²æ­¢è®¿é—®é‡è¿‡å¤§ï¼Œå¯ä»¥å°†è¯·æ±‚åˆ†åˆ°å…¶ä»–æœåŠ¡æä¾›æ–¹ä¸Šï¼Œå‡å°‘å®•æœºã€å´©æºƒçš„é£é™©ï¼‰**

- è‡ªå·±ä»£ç å®ç°  
- zookeeperæœ¬èº«å°±èƒ½å®ç°è½¯è´Ÿè½½å‡è¡¡å§   å¯ä»¥åœ¨zookeeperä¸­è®°å½•æ¯å°æœåŠ¡å™¨çš„è®¿é—®æ¬¡æ•°ï¼Œè®©è®¿é—®æœ€å°‘çš„å»å¤„ç†æœ€æ–°çš„å®¢æˆ·ç«¯è¯·æ±‚

### å…¶ä»–æœºåˆ¶ï¼š

- å¿ƒè·³æœºåˆ¶
- è§£å†³ç²˜åŒ…ã€æ‹†åŒ…é—®é¢˜
- æ³¨è§£å¼€å‘ç­‰ç­‰





## RPCæ¡†æ¶v1.0ç®€æ˜“ç‰ˆ

`è¦æ±‚ç®€å•å®ç°è¿œç¨‹è°ƒç”¨`

==ç”¨æœ€ç¬¨çš„æ–¹æ³•å®ç°==

### æŠ€æœ¯é€‰å‹

- ç½‘ç»œä¼ è¾“ï¼šnio
- åºåˆ—åŒ–ï¼šjavaè‡ªå¸¦åºåˆ—åŒ–

### å®¢æˆ·ç«¯

**æ¶ˆè´¹è€…å¯åŠ¨ç«¯**

```java
package consumer.bootstrap;

import consumer.nio.NIOClient;

import java.io.IOException;

/*
    ä»¥nioä¸ºç½‘ç»œç¼–ç¨‹æ¡†æ¶çš„æ¶ˆè´¹è€…ç«¯å¯åŠ¨ç±»
 */
public class NIOConsumerBootStrap {
    public static void main(String[] args) throws IOException {
        NIOClient.start("127.0.0.1",6666);
    }
}

```

**æ¶ˆè´¹è€…å®é™…ä¸šåŠ¡ç«¯**

```java
package consumer.nio;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.SocketChannel;
import java.nio.charset.StandardCharsets;
import java.util.Iterator;
import java.util.Scanner;

public class NIOClient {
    public static void start(String HostName, int PORT) throws IOException{
        start0(HostName,PORT);
    }

    //çœŸæ­£å¯åŠ¨åœ¨è¿™
    private static void start0(String hostName, int port) throws IOException {
        //å¾—åˆ°ä¸€ä¸ªç½‘ç»œé€šé“
        SocketChannel socketChannel = SocketChannel.open();
        System.out.println("-----------æœåŠ¡æ¶ˆè´¹æ–¹å¯åŠ¨-------------");
        socketChannel.configureBlocking(false);
        //å»ºç«‹é“¾æ¥  éé˜»å¡è¿æ¥  ä½†æˆ‘ä»¬æ˜¯è¦ç­‰ä»–è¿æ¥ä¸Š
        if (!socketChannel.connect(new InetSocketAddress(hostName,port))) {
            while (!socketChannel.finishConnect());
        }
        //åˆ›å»ºé€‰æ‹©å™¨ è¿›è¡Œç›‘å¬è¯»äº‹ä»¶
        Selector selector = Selector.open();
        socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));
        //åˆ›å»ºåŒ¿åçº¿ç¨‹è¿›è¡Œç›‘å¬è¯»äº‹ä»¶
        new Thread(new Runnable() {
            @Override
            public void run() {
                while (true)
                {
                    //æ•è·å¼‚å¸¸  ç›‘å¬è¯»äº‹ä»¶
                    try {
                        if (selector.select(1000)==0)
                        {
                            continue;
                        }
                        Iterator<SelectionKey> keyIterator = selector.selectedKeys().iterator();
                        while (keyIterator.hasNext())
                        {
                            SelectionKey key = keyIterator.next();
                            ByteBuffer buffer = (ByteBuffer)key.attachment();
                            SocketChannel channel = (SocketChannel)key.channel();
                            int read = 1;
                            //ç”¨è¿™ä¸ªçš„åŸå› æ˜¯æ€• å¤šçº¿ç¨‹å‡ºç°å½±å“
                            StringBuffer stringBuffer = new StringBuffer();
                            while (read!=0)
                            {
                                buffer.clear();
                                read = channel.read(buffer);
                                stringBuffer.append(new String(buffer.array(),0,read));
                            }
                            System.out.println("æ”¶åˆ°æœåŠ¡ç«¯å›ä¿¡"+stringBuffer.toString());
                            keyIterator.remove();
                        }
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                }
            }
        }).start();

        //çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘  ç­‰å¾…é”®ç›˜ä¸Šçš„è¾“å…¥ è¿›è¡Œå‘é€ä¿¡æ¯
        Scanner scanner = new Scanner(System.in);
        while (true)
        {
            int methodNum = scanner.nextInt();
            String message = scanner.next();
            String msg = new String(methodNum+"#"+message);
            socketChannel.write(ByteBuffer.wrap(msg.getBytes(StandardCharsets.UTF_8)));
            System.out.println("æ¶ˆæ¯å‘é€");
        }
    }
}
```





### æœåŠ¡ç«¯

**æœåŠ¡æä¾›è€…å¯åŠ¨ç«¯**

```java
package provider.bootstrap;

import provider.nio.NIOServer;

import java.io.IOException;

/*
    ä»¥nioä¸ºç½‘ç»œç¼–ç¨‹æ¡†æ¶çš„æœåŠ¡æä¾›ç«¯å¯åŠ¨ç±»
 */
public class NIOProviderBootStrap {
    public static void main(String[] args) throws IOException {
        NIOServer.start(6666);
    }
}

```

**æœåŠ¡æä¾›è€…å®é™…ä¸šåŠ¡ç«¯**

```java
package provider.nio;

import api.ByeService;
import api.HelloService;
import provider.api.ByeServiceImpl;
import provider.api.HelloServiceImpl;

import java.io.IOException;
import java.net.InetSocketAddress;
import java.nio.ByteBuffer;
import java.nio.channels.*;
import java.nio.charset.StandardCharsets;
import java.util.Iterator;
import java.util.Set;

public class NIOServer {

    //å¯åŠ¨
    public static void start(int PORT) throws IOException {
        start0(PORT);
    }

    //TODO å½“æœåŠ¡æ¶ˆè´¹æ–¹ä¸‹æœºæ—¶  ä¿æŒå¼€å¯çŠ¶æ€

    /*
        çœŸæ­£å¯åŠ¨çš„ä¸šåŠ¡é€»è¾‘åœ¨è¿™
        å› ä¸ºè¿™æ˜¯ç®€æ˜“ç‰ˆ é‚£ä¹ˆå…ˆæŠŠå¼‚å¸¸ä¸¢å‡ºå»
     */
    private static void start0(int port) throws IOException {
        //åˆ›å»ºå¯¹åº”çš„æœåŠ¡å™¨ç«¯é€šé“
        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
        System.out.println("-----------æœåŠ¡æä¾›æ–¹å¯åŠ¨-------------");
        //å¼€å¯ä¸€ä¸ªé€‰æ‹©å™¨ å°†è‡ªå·±è¦
        Selector selector = Selector.open();

        //ç»‘å®šç«¯å£å¼€å¯
        serverSocketChannel.bind(new InetSocketAddress(port));

        //è¿™é‡Œæ³¨æ„ è¦è®¾ç½®éé˜»å¡   é˜»å¡çš„è¯  ä»–ä¼šä¸€ç›´ç­‰å¾…äº‹ä»¶æˆ–è€…æ˜¯å¼‚å¸¸æŠ›å‡ºçš„æ—¶å€™æ‰ä¼šç»§ç»­ ä¼šæµªè´¹cpu
        serverSocketChannel.configureBlocking(false);

        //è¦å…ˆè®¾ç½®éé˜»å¡ å†æ³¨å†Œ  å¦‚æœæ—¶å…ˆæ³¨å†Œå†è®¾ç½®éé˜»å¡ä¼šæŠ¥é”™
        serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);

        //çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ å°±æ˜¯ä¸‹é¢
        //å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥å’Œæ£€æŸ¥äº‹ä»¶çš„å‘ç”Ÿ
        while (true)
        {
            //1ç§’é’Ÿæ— äº‹å‘ç”Ÿçš„è¯  å°±ç»§ç»­
            if (selector.select(1000)==0)
            {
                continue;
            }

            //è·å–æ‰€æœ‰çš„å¯¹è±¡
            Set<SelectionKey> selectionKeys = selector.selectedKeys();
            Iterator<SelectionKey> keyIterator = selectionKeys.iterator();

            while (keyIterator.hasNext())
            {
                SelectionKey key = keyIterator.next();
                if (key.isAcceptable())
                {
                    SocketChannel socketChannel = serverSocketChannel.accept();
                    System.out.println("è¿æ¥åˆ°æ¶ˆè´¹ç«¯"+socketChannel.socket().getRemoteSocketAddress());
                    socketChannel.configureBlocking(false);
                    socketChannel.register(selector,SelectionKey.OP_READ, ByteBuffer.allocate(1024));
                }
                if (key.isReadable())
                {
                    //åå‘è·å–ç®¡é“
                    SocketChannel socketChannel = (SocketChannel)key.channel();
                    //åå‘è·å–Buffer
                    ByteBuffer buffer = (ByteBuffer)key.attachment();
                    //è¿›è¡Œè°ƒç”¨æ–¹æ³•å¹¶è¿”å›
                    //è·å¾—ä¿¡æ¯
                    StringBuffer stringBuffer = new StringBuffer();
                    int read = 1;
                    while (read!=0)
                    {
                        //å…ˆæ¸…ç©º é˜²æ­¢æ®‹ç•™
                        buffer.clear();
                        read = socketChannel.read(buffer);
                        //æ·»åŠ çš„æ—¶å€™  æ ¹æ®è¯»å…¥çš„æ•°æ®è¿›è¡Œ
                        stringBuffer.append(new String(buffer.array(),0,read));
                    }
                    //æ–¹æ³•å·å’Œä¿¡æ¯ä¸­é—´æœ‰ä¸ª#è¿›è¡Œåˆ†å‰²
                    String msg = stringBuffer.toString();
                    String[] strings = msg.split("#");
                    String response;
                    if (strings.length<2)
                    {
                        //å½“å‡ºç°ä¼ å…¥é”™è¯¯çš„æ—¶å€™ æŠ¥å¼‚å¸¸
                        System.out.println("ä¼ å…¥é”™è¯¯");
                        throw new RuntimeException();
                    }
                    if (strings[0].equals("1"))
                    {
                        HelloService helloService = new HelloServiceImpl();
                        response = helloService.sayHello(strings[1]);
                    }
                    else if (strings[0].equals("2"))
                    {
                        ByeService byeService = new ByeServiceImpl();
                        response = byeService.sayBye(strings[1]);
                    }
                    else
                    {
                        //å½“å‡ºç°ä¼ å…¥é”™è¯¯çš„æ—¶å€™ æŠ¥å¼‚å¸¸
                        System.out.println("ä¼ å…¥é”™è¯¯");
                        throw new RuntimeException();
                    }
                    String responseMsg = "æ”¶åˆ°ä¿¡æ¯" + strings[1] + "æ¥è‡ª" + socketChannel.socket().getRemoteSocketAddress();
                    System.out.println(responseMsg);
                    //å°†è°ƒç”¨æ–¹æ³•åè·å¾—çš„ä¿¡æ¯å›æ˜¾
                    ByteBuffer responseBuffer = ByteBuffer.wrap(response.getBytes(StandardCharsets.UTF_8));
                    //å†™å›ä¿¡æ¯
                    socketChannel.write(responseBuffer);
                }
                keyIterator.remove();
            }
        }
    }
}

```



### åºåˆ—åŒ–

JDKè‡ªå¸¦åºåˆ—åŒ–



### ä¾èµ–å¼•å…¥

`æœ€å¤–å±‚pomå¼•å…¥ä¾èµ–`

```xml

<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>coder.zyt</groupId>
    <artifactId>zeng-rpc-framework</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>zyt-rpc-consumer</module>
        <module>zyt-rpc-provider</module>
        <module>zyt-rpc-api</module>
        <module>zyt-rpc-common</module>
    </modules>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
    <dependencies>
        <!--æ–¹ä¾¿æ„å»ºç±»-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <version>1.18.22</version>
        </dependency>
        <!--æ‰“å°æ—¥å¿—ä¿¡æ¯-->
        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>1.7.25</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-log4j12</artifactId>
            <version>1.7.25</version>
        </dependency>
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-simple</artifactId>
            <version>1.7.25</version>
            <scope>test</scope>
        </dependency>
        <!--æµ‹è¯•-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <version>2.5.1</version>
        </dependency>

    </dependencies>
</project>
```



### æ›´æ–°ï¼ˆè¡¥ä¸ï¼‰

#### **v1.1**

==*æ›´æ–°äº‹é¡¹*==

- **è§£å†³å®¢æˆ·ç«¯æ–­å¼€è¿æ¥å æœåŠ¡å™¨ç«¯ä¹Ÿä¼šå¼ºåˆ¶ä¸‹çº¿çš„é—®é¢˜**

  - åŸå› ï¼šå½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥å æœåŠ¡ç«¯çš„selectä¼šç›‘å¬åˆ°äº‹ä»¶  isReadable()ä¸ä»…ä¼šç›‘å¬åˆ°è¯»äº‹ä»¶è¿˜ä¼šç›‘å¬åˆ°ç©å®¶ä¸‹çº¿çš„äº‹ä»¶ã€‚

  - è§£å†³æ–¹æ¡ˆï¼šåœ¨è¯»äº‹ä»¶æ•è·å¼‚å¸¸ ä¼˜é›…çš„å…³é—­ç®¡é“    ä¸‹é¢æ˜¯ä»£ç å®ç°

    ```java
    try{
        //ä¹‹å‰çš„ä¸šåŠ¡é€»è¾‘
    }
    catch (IOException e) {                 
        //è¿›è¡Œå…³é—­ å¹¶ç»§ç»­æ‰§è¡Œ  å–æ¶ˆé”®çš„æ³¨å†Œ è¿˜æœ‰å…³é—­ç®¡é“     
        SocketChannel unConnectChannel = (SocketChannel)key.channel();                     System.out.println(((unConnectChannel.socket().getRemoteSocketAddress())+"ä¸‹çº¿äº†"));
    	key.cancel();
        unConnectChannel.close();
    } catch (RuntimeException e) {
        e.printStackTrace();
    }
    ```

- **è§£å†³ä¼ è¾“æ—¶ å¯èƒ½å‡ºç°çš„æ²¾åŒ…æ‹†åŒ…é—®é¢˜**

  ![1651044110072](images/1651044110072.png)

  

  - åŸå› ï¼šTCPæ˜¯ä¸€ä¸ªâ€œæµâ€åè®®ï¼Œæ˜¯æ²¡æœ‰ç•Œé™çš„ä¸€ä¸²æ•°æ®ï¼ŒTCPåº•å±‚å¹¶ä¸äº†è§£ä¸Šå±‚ä¸šåŠ¡æ•°æ®çš„å…·ä½“å«ä¹‰ï¼Œå®ƒä¼šæ ¹æ®TCPç¼“å†²åŒºçš„å®é™…æƒ…å†µè¿›è¡ŒåŒ…çš„åˆ’åˆ†ï¼Œæ‰€ä»¥åœ¨ä¸šåŠ¡ä¸Šè®¤ä¸ºï¼Œä¸€ä¸ªå®Œæ•´çš„åŒ…å¯èƒ½ä¼šè¢«TCPæ‹†æˆå¤šä¸ªåŒ…è¿›è¡Œå‘é€ï¼Œä¹Ÿæœ‰å¯èƒ½æŠŠå¤šä¸ªå°çš„åŒ…å°è£…æˆä¸€ä¸ªå¤§çš„æ•°æ®åŒ…å‘é€ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„TCPç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜ã€‚
- è§£å†³æ–¹æ¡ˆï¼šè®¾ç½®ä¸€ä¸ªæ ‡è¯†ç¬¦  è¯»åˆ°æ ‡è¯†ç¬¦æ—¶æš‚åœ   æ›´æ¢è‡ªå·±çš„æ¶ˆæ¯å‘é€æ–¹å¼ é€šè¿‡channel  ç°åœ¨æ”¹æˆio   
  `éé˜»å¡çš„ç½‘ç»œioè¯»å†™åªèƒ½ç”¨åˆ°readå’Œwrite`ä½†è¿™ä¸ªå°±æ˜¯åªèƒ½ä½¿ç”¨ é˜»å¡çš„nioäº†`é¢å¤–å¼€äº†ä¸€ä¸ªåŒ…`å®ç°    ä¸‹é¢æ˜¯ä»£ç å®ç°
- **å°è¯•ä½¿ç”¨é˜»å¡ioè§£å†³ç²˜åŒ…é—®é¢˜**
  
  ```java
  //æ–°å»ºè¯·æ±‚å‘é€ç±»
  package entity;
  
  import lombok.AllArgsConstructor;
  import lombok.Data;
  import lombok.NoArgsConstructor;
  
  //ç½‘ç»œä¼ è¾“è¯·æ±‚   é‡ç‚¹æ˜¯è¦å®ç°åºåˆ—åŒ– å¦åˆ™ä¸èƒ½è¿›è¡Œioä¼ è¾“
  @Data
  @AllArgsConstructor
  @NoArgsConstructor
  public class RpcRequest implements Serializable{
      //æ–¹æ³•ç¼–å·
  int methodNum;
      //æ¶ˆæ¯ä½“
  String message;
  }
  ```
  
  
  ```java
  //æ¶ˆè´¹è€…ç«¯
  package consumer.nio;
  import entity.RpcRequest;
  import java.io.IOException;
  import java.io.ObjectInputStream;
  import java.io.ObjectOutputStream;
  import java.net.InetSocketAddress;
  import java.nio.channels.SocketChannel;
  import java.util.Scanner;
  //é˜»å¡NIOæ¶ˆè´¹ç«¯ è§£å†³æ²¾åŒ…é—®é¢˜
  public class NIOBlockingClient {
      public static void start(String HostName, int PORT) throws IOException {
          start0(HostName,PORT);
      }
  
      //çœŸæ­£å¯åŠ¨åœ¨è¿™
      private static void start0(String hostName, int port) throws IOException {
          //å¾—åˆ°ä¸€ä¸ªç½‘ç»œé€šé“
          SocketChannel socketChannel = SocketChannel.open();
          System.out.println("-----------æœåŠ¡æ¶ˆè´¹æ–¹å¯åŠ¨-------------");
          //è®¾ç½®é˜»å¡
          socketChannel.configureBlocking(true);
          //å»ºç«‹é“¾æ¥  é˜»å¡è¿æ¥  ä½†æˆ‘ä»¬æ˜¯è¦ç­‰ä»–è¿æ¥ä¸Š
         socketChannel.connect(new InetSocketAddress(hostName,port));
  
          //çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘  ç­‰å¾…é”®ç›˜ä¸Šçš„è¾“å…¥ è¿›è¡Œå‘é€ä¿¡æ¯
          Scanner scanner = new Scanner(System.in);
  
          //è¾“å…¥è¾“å‡ºé€šé“éƒ½æ”¾åœ¨å¤–é¢
  
          ObjectOutputStream outputStream = new ObjectOutputStream(socketChannel.socket().getOutputStream());
          ObjectInputStream objectInputStream = new ObjectInputStream(socketChannel.socket().getInputStream());
          //éƒ½æ˜¯é˜»å¡ç­‰å¾… å‘å®Œäº† æ¥æ”¶å®Œäº† æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥ ä¸ç„¶ä¼šæŠ¥å¼‚å¸¸
          while (true)
          {
              int methodNum = scanner.nextInt();
              String message = scanner.next();
              RpcRequest request = new RpcRequest(methodNum,message);
              //è¿›è¡Œä¿®è®¢ ä½¿å¾—å¯ä»¥ä¼ é€å¯¹è±¡ é€šè¿‡è‡ªå¸¦çš„ioæµè¿›è¡Œ é¿å…å‡ºç°æ²¾åŒ…æ‹†åŒ…ç°è±¡
  
              outputStream.writeObject(request);
              System.out.println("æ¶ˆæ¯å‘é€");
              try {
  
                  String msg = (String)objectInputStream.readObject();
                  System.out.println("æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„æ¶ˆæ¯"+msg);
              } catch (ClassNotFoundException e) {
                  e.printStackTrace();
              }
          }
      }
  }
  
  ```
  
  
  ```java
  //NIOéé˜»å¡æœåŠ¡æä¾›æ–¹ ä¸»è¦çš„ä»£ç 
  
  package provider.nio;
  
  import api.ByeService;
  import api.HelloService;
  import entity.RpcRequest;
  import provider.api.ByeServiceImpl;
  import provider.api.HelloServiceImpl;
  
  import java.io.*;
  import java.net.InetSocketAddress;
  import java.nio.channels.Selector;
  import java.nio.channels.ServerSocketChannel;
  import java.nio.channels.SocketChannel;
  
  //é˜»å¡NIOæœåŠ¡æä¾›ç«¯ è§£å†³æ²¾åŒ…é—®é¢˜
  public class NIOBlockingServer {
      //å¯åŠ¨
      public static void start(int PORT) throws IOException {
          start0(PORT);
      }
      //TODO å½“æœåŠ¡æ¶ˆè´¹æ–¹ä¸‹æœºæ—¶  ä¿æŒå¼€å¯çŠ¶æ€
  
  /*
      çœŸæ­£å¯åŠ¨çš„ä¸šåŠ¡é€»è¾‘åœ¨è¿™
      å› ä¸ºè¿™æ˜¯ç®€æ˜“ç‰ˆ é‚£ä¹ˆå…ˆæŠŠå¼‚å¸¸ä¸¢å‡ºå»
   */
  private static void start0(int port) throws IOException {
      //åˆ›å»ºå¯¹åº”çš„æœåŠ¡å™¨ç«¯é€šé“
      ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();
      System.out.println("-----------æœåŠ¡æä¾›æ–¹å¯åŠ¨-------------");
      //å¼€å¯ä¸€ä¸ªé€‰æ‹©å™¨ å°†è‡ªå·±è¦
      Selector selector = Selector.open();
  
      //ç»‘å®šç«¯å£å¼€å¯
      serverSocketChannel.bind(new InetSocketAddress(port));
  
      //è®¾ç½®é˜»å¡
      serverSocketChannel.configureBlocking(true);
  
      //çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘ å°±æ˜¯ä¸‹é¢
      //å¾ªç¯ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥å’Œæ£€æŸ¥äº‹ä»¶çš„å‘ç”Ÿ
      while (true)
      {
          SocketChannel channel = serverSocketChannel.accept();
          System.out.println("æ¥è‡ª"+channel.socket().getRemoteSocketAddress()+"çš„è¿æ¥");
          new Thread(new Runnable() {
              @Override
              public void run() {
                  try {
                      //åœ¨å†…éƒ¨ä¸æ–­çš„è¿›è¡Œç›‘å¬
                      InputStream inputStream = channel.socket().getInputStream();
                      OutputStream outputStream = channel.socket().getOutputStream();
                      ObjectInputStream objectInputStream = new ObjectInputStream(inputStream);
                      ObjectOutputStream objectOutputStream = new ObjectOutputStream(outputStream);
                      while (true)
                      {
                          String response;
                          RpcRequest request = (RpcRequest)objectInputStream.readObject();
                          if (request.getMethodNum()==1)
                          {
                              HelloService helloService = new HelloServiceImpl();
                              response = helloService.sayHello(request.getMessage());
                          }
                          else if (request.getMethodNum()==2)
                          {
                              ByeService helloService = new ByeServiceImpl();
                              response = helloService.sayBye(request.getMessage());
                          }
                          else
                          {
                              System.out.println("ä¼ å…¥é”™è¯¯");
                              throw new RuntimeException();
                          }
                          System.out.println("æ”¶åˆ°å®¢æˆ·ç«¯"+channel.socket().getRemoteSocketAddress()+"çš„æ¶ˆæ¯"+response);
                          objectOutputStream.writeObject(response);
                      }
                  } catch (Exception e) {
                      System.out.println("channel"+channel.socket().getRemoteSocketAddress()+"æ–­å¼€è¿æ¥");
                      try {
                          channel.close();
                      } catch (IOException ex) {
                          ex.printStackTrace();
                      }
                  }
              }
          }).start();
      }
  }
  }
  ```



#### **v1.2**

==*æ›´æ–°äº‹é¡¹*== `ä»¥ä¸‹æ›´æ–°å‡åœ¨éé˜»å¡æ¨¡å—è¿›è¡Œæ›´æ–°ï¼Œé˜»å¡æ¨¡å—å¯ä¾›è¯»è€…è‡ªå·±å°è¯•`

- **è¿›ä¸€æ­¥å‡å°‘ç”¨æˆ·ä½¿ç”¨çš„å¤æ‚æ„Ÿ  ä¹‹å‰åˆ†è¾¨æ–¹æ³•æ˜¯é€šè¿‡åˆ¤æ–­ä¼ é€’çš„å­—ç¬¦ä¸²ã€ç±»å‹ä¸­çš„æ–¹æ³•ç¼–å·å­—æ®µæ¥æŠ‰æ‹©çš„ï¼Œè¿™æ¬¡çš„è¯ï¼Œå°†æ›´åŠ ç²¾ç®€ï¼Œä½¿ç”¨æ³¨å†Œä¸­å¿ƒï¼Œ==ç›®å‰æ¯ä¸ªæœåŠ¡æä¾›è€…æ¯äººåªæä¾›ä¸€ä¸ªæœåŠ¡ï¼Œå…¶ä»–çš„æ—¥åå†å®Œå–„==**

  - é¦–å…ˆæˆ‘åšçš„æ˜¯å°†zookeeperçš„åœ°å€è®¾ç½®ä¸ºå¸¸é‡è¿™æ ·ï¼Œä¹‹åæ¯æ¬¡åœ¨åˆ›å»ºzookeeperè¿æ¥ä¸­åœ°å€å‚æ•°å¯ä»¥ç›´æ¥æ‹¿ï¼ŒåŒæ—¶ä¿®æ”¹èµ·æ¥ä¹Ÿæ–¹ä¾¿ï¼ŒæŠŠsessionTimeoutä¹Ÿè®¾ä¸ºå¸¸é‡

    ```java
    package constants;
    
    public class RpcConstants {
        //zookeeperæœåŠ¡å™¨è¿æ¥åœ°å€
        public static String ZOOKEEPER_ADDRESS = "zytCentos:2181";
        //è¶…æ—¶æ—¶é—´
        public static int ZOOKEEPER_SESSION_TIMEOUT = 2000;
    }
    
    ```

  - å®ç°æœåŠ¡æä¾›ç«¯å°†å¯¹åº”åœ°å€æ³¨å†Œåˆ°zookeeperä¸­
    

    ```java
    package zkService;
    
    import constants.RpcConstants;
    import org.apache.zookeeper.*;
    import org.apache.zookeeper.data.Stat;
    
    import java.io.IOException;
    import java.nio.charset.StandardCharsets;
    
    
    //è¯¥ç±»å°†å¯¹åº”æœåŠ¡ç«¯çš„æ–¹æ³•å’Œç›¸åº”çš„ç«¯å£å’Œåœ°å€ï¼Œæ³¨å†Œåˆ°zooKeeperä¸­
    public class ZkServiceRegistry {
        private static String connectString = RpcConstants.ZOOKEEPER_ADDRESS;
        private static int sessionTimeout = RpcConstants.ZOOKEEPER_SESSION_TIMEOUT;
        private static ZooKeeper zooKeeper;
    
        static void createConnect() throws IOException {
            zooKeeper = new ZooKeeper(connectString, sessionTimeout, new Watcher() {
                @Override
                public void process(WatchedEvent watchedEvent) {
    
                }
            });
        }
    
        //åˆ›å»ºæˆåŠŸåæŠŠæ–¹æ³•æ³¨å†Œè¿›å»
        static void register(String RpcServiceName,String hostname,int port) throws InterruptedException, KeeperException {
            //èŠ‚ç‚¹åå°±æ˜¯æ–¹æ³•å  ç„¶åå¯¹åº”çš„æ•°æ®å°±æ˜¯hostname+"ï¼š"+port
    
    
            //å› ä¸ºè¿™ä¸ªåœ°åŒºå±äºä¸€ä¸ªä¸´ç•ŒåŒº å¯èƒ½ä¼šå‘ç”Ÿçº¿ç¨‹ä¸å®‰å…¨é—®é¢˜ æ‰€ä»¥è¿›è¡Œä¸ŠğŸ”’
            synchronized (ZkServiceRegistry.class) {
                Stat exists = zooKeeper.exists("/service", null);
                if (exists ==null) {
                    zooKeeper.create("/service",
                            "".getBytes(StandardCharsets.UTF_8),
                            ZooDefs.Ids.OPEN_ACL_UNSAFE,
                            CreateMode.PERSISTENT
                    );
                }
            }
    
            String date = hostname+":"+port;
    
            //æƒé™ç›®å‰éƒ½è®¾ç½®ä¸ºå…¨æ”¾å¼€   åˆ›å»ºæ–¹å¼å‡ä¸ºæŒä¹…åŒ–
            zooKeeper.create("/service/"+RpcServiceName,
                    date.getBytes(StandardCharsets.UTF_8),
                    ZooDefs.Ids.OPEN_ACL_UNSAFE,
                    CreateMode.PERSISTENT
                    );
        }
    
        /**
         *
         * @param RpcServiceName è¿™æ˜¯å¯¹åº”çš„æœåŠ¡å
         * @param hostname å’Œå¯ä»¥è°ƒç”¨è¯¥æœåŠ¡çš„ip
         * @param port  è¿˜æœ‰å¯¹åº”çš„ç«¯å£å·
         * @throws IOException
         * @throws InterruptedException
         */
        public static void registerMethod(String RpcServiceName,String hostname,int port) throws IOException, InterruptedException, KeeperException {
            //å…ˆåˆ›å»ºå¯¹åº”çš„é¢zooKeeperè¿æ¥å®¢æˆ·ç«¯å†è¿›è¡Œç›¸åº”çš„æ³¨å†Œ
            createConnect();
            register(RpcServiceName,hostname,port);
            System.out.println("æœåŠ¡ç«¯:"+hostname+":"+port+"æ–¹æ³•æ³¨å†Œå®Œæ¯•");
    
        }
    }
    
    ```

    ==è¿›è¡Œæµ‹è¯•==

    `å­˜åœ¨é—®é¢˜` æµ‹è¯•å‡ºç°é—®é¢˜ å¯åŠ¨ä¸¤ä¸ªæœåŠ¡åªæœ‰ä¸€ä¸ªæœåŠ¡çš„æ–¹æ³•æ³¨å†Œè¿›å»äº†ï¼›
    `è§£å†³æ–¹æ³•` å› ä¸ºæˆ‘æ¯ä¸ªæœåŠ¡æä¾›æ–¹åˆ°åé¢éƒ½æ˜¯å¾ªç¯ç€ç›‘å¬ æ‰€ä»¥ç¬¬ä¸€ä¸ªè¿›å»äº†å°±å‡ºä¸æ¥ç«‹åˆ»  å¼€äº†å¤šä¸ªçº¿ç¨‹

    `å­˜åœ¨é—®é¢˜` å°±æ˜¯ä¼šé‡å¤è¿›è¡Œåˆ›å»ºserviceèŠ‚ç‚¹  åº”è¯¥æ˜¯å¼•å…¥äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ å°±æ˜¯å•ä¾‹æ¨¡å¼æ‡’æ±‰æ¨¡å¼1ä¸­ç±»ä¼¼çš„é—®é¢˜
    `è§£å†³æ–¹æ³•` å¯¹æ–¹æ³•è¿›è¡ŒåŠ é” ä½¿ç”¨äº†synchronizedé”ï¼Œè¯¥é”jdk1.6ä¹‹åè¿›è¡Œäº†ä¼˜åŒ–å¯ä»¥ä½¿ç”¨ï¼

    `æˆåŠŸè§£å†³`

    

  - æœåŠ¡æä¾›æ–¹å¯åŠ¨ä»£ç å¦‚ä¸‹ï¼ˆé‡åˆ°äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ ä¹‹åå°è¯•å¦‚ä½•è¿›ä¸€æ­¥ä¼˜åŒ–ï¼‰

    ```java
    /*
        ä»¥nioä¸ºç½‘ç»œç¼–ç¨‹æ¡†æ¶çš„æœåŠ¡æä¾›ç«¯å¯åŠ¨ç±»  åŠ å…¥äº†zk  é‡åˆ°äº†çº¿ç¨‹å®‰å…¨é—®é¢˜ æˆåŠŸè§£å†³äº†
     */
    public class NIOProviderBootStrap12 {
        public static void main(String[] args) throws IOException, InterruptedException, KeeperException {
            //å¯åŠ¨
            new Thread(new Runnable() {
                @Override
                public void run() {
                    //å› ä¸ºæ¯ä¸ªæœåŠ¡æä¾›ç«¯å†…éƒ¨éƒ½æ˜¯åœ¨ç›‘å¬å¾ªç¯é˜»å¡ æ¯ä¸ªå¼€å¯ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œç›‘å¬
                    try {
                        NIONonBlockingServer12hello.start(6666);
                    } catch (IOException e) {
                        e.printStackTrace();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    } catch (KeeperException e) {
                        e.printStackTrace();
                    }
                }
            }).start();
    
            //å¯åŠ¨
            new Thread(new Runnable() {
                @Override
                public void run() {
                    try {
                        NIONonBlockingServer12bye.start(6667);
                    } catch (IOException e) {
                        e.printStackTrace();
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    } catch (KeeperException e) {
                        e.printStackTrace();
                    }
                }
            }).start();
        }
    }
    
    ```

    

  - å®ç°æ¶ˆè´¹è€…ç«¯è·å–æ‰€éœ€æœåŠ¡å¯¹åº”çš„åœ°å€

    ```java
    //é€šè¿‡æ–¹æ³•å åè¿‡æ¥è·å–æœåŠ¡å¯¹åº”çš„åœ°å€
    public class ZkServiceDiscovery {
        private static String connectString = RpcConstants.ZOOKEEPER_ADDRESS;
        private static int sessionTimeout = RpcConstants.ZOOKEEPER_SESSION_TIMEOUT;
        private static ZooKeeper zooKeeper;
    
        //ç¬¬ä¸€æ­¥å½“ç„¶æ˜¯è¿æ¥åˆ°è¿œç«¯æœåŠ¡å™¨ä¸Šäº†
        public static void getConnect() throws IOException {
            zooKeeper = new ZooKeeper(connectString, sessionTimeout, new Watcher() {
                @Override
                public void process(WatchedEvent watchedEvent) {
    
                }
            });
        }
    
        // æ ¹æ®æ‰€è¯·æ±‚çš„æœåŠ¡åœ°å€ è·å–å¯¹åº”çš„è¿œç«¯åœ°å€
        public static String getMethodAddress(String methodName) throws RpcException, InterruptedException, KeeperException {
    
            //åˆ¤æ–­èŠ‚ç‚¹ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”è·¯å¾„  ä¸å­˜åœ¨åˆ™æŠ›å‡ºå¼‚å¸¸
            if (zooKeeper.exists("/service/"+methodName,null)==null)
            {
                System.out.println("ä¸å­˜åœ¨è¯¥æ–¹æ³•");
                throw new RpcException();
            }
    
            //åˆ°å¯¹åº”èŠ‚ç‚¹ä¸­è·å–åœ°å€   statèŠ‚ç‚¹çŠ¶æ€ä¿¡æ¯å˜é‡
            byte[] data = zooKeeper.getData("/service/" + methodName, false,null);
            String address = new String(data);
            return address;
        }
    
        public static void getStart(String methodName) throws IOException, RpcException, InterruptedException, KeeperException {
            //å…ˆè¿›è¡Œè¿æ¥
            getConnect();
            //è·å–ç›¸åº”çš„è¿œç«¯åœ°å€
            String methodAddress = getMethodAddress(methodName);
            //è¿›è¡Œè¿æ¥
            String[] strings = methodAddress.split(":");
            //å¯åŠ¨
            String address = strings[0];
            int port = Integer.valueOf(strings[1]);
            NIONonBlockingClient12.start(address,port);
        }
    }
    ```

    

    

- **ç”¨ä»£ç†æ¨¡å¼ è®©ç”¨æˆ·æ„Ÿè§‰åœ¨è°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œè°ƒç”¨è¿œç«¯æ–¹æ³•ã€‚**

  - å‰é¢çš„æ”¹åŠ¨å°šä¸èƒ½å®ç°ï¼Œéœ€è¦åŠ ä¸Šç°åœ¨ä¸‹é¢è¿™ä¸€éƒ¨åˆ†ï¼Œä»£ç†æ¨¡å¼ï¼Œæ‰èƒ½æ›´å¥½çš„å®ç°ç”¨æˆ·çš„è¿œç«¯è°ƒç”¨

  - è®¾è®¡è¢«ä»£ç†ç”¨æˆ·ç±»

    ```java
    //è¿™æ˜¯ä¹‹åè¦è¢«ä»£ç†çš„å¯¹è±¡ æˆ‘ä»¬ä¼šå®ç°å®ƒçš„æ–¹æ³•
    public interface Customer {
        String sayBye(String saying);
        String sayHello(String saying);
    }
    ```

  - è®¾è®¡ä»£ç†ç±» //å®ç°äº†è°ƒç”¨åå›ä¼ çš„åŠŸèƒ½  åƒæœ¬èº«è°ƒç”¨ä¸€æ ·

    ```java
    package consumer.proxy;
    
    import consumer.zkService.ZkServiceDiscovery;
    
    
    import java.lang.reflect.InvocationHandler;
    import java.lang.reflect.Method;
    import java.lang.reflect.Proxy;
    
    //ä»£ç†ç±»çš„å®ç°
    public class RpcClientProxy {
    
        //è·å–ä»£ç†å¯¹è±¡ å¹¶è¿”å› å½“å‰ç±»åˆ«
        public static Object getBean(final Class<?> serviceClass){
            /*
                å‚æ•°è¯¦è§£
                1ã€ç”¨å“ªä¸ªç±»åŠ è½½å™¨å»åŠ è½½å¯¹è±¡
                2ã€åŠ¨æ€ä»£ç†ç±»éœ€è¦å®ç°çš„æ¥å£ class[]{xxxx.class} å¾—åˆ°çš„å°±æ˜¯å¯¹åº”çš„ç±»åˆ«
                3ã€åŠ¨æ€ä»£ç†ç±»æ‰§è¡Œæ–¹æ³•çš„æ—¶å€™éœ€è¦å¹²çš„äº‹
             */
            return Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),
                    new Class[]{serviceClass},
                    new InvocationHandler() {
                        @Override
                        public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
                            //æš‚æ—¶è¿˜æ²¡æœ‰è®¾ç½®å›ä¿¡è¿™ä¸ªæ“ä½œ
                            String methodName = method.getName();
                            String response = ZkServiceDiscovery.getStart(methodName, (String) args[0]);
                            return response;
                        }
                    }
            );
        }
    }
    ```

  - ä¿®æ”¹äº†æ¶ˆè´¹è€…ç«¯çš„æ–¹æ³•ï¼Œå’Œä¹‹å‰çš„åŠŸèƒ½ä¸ä¸€æ ·äº†ï¼Œä¹‹å‰æ˜¯å±äºåœ¨æ§åˆ¶å°è¾“å…¥ æŒç»­çš„å›å¤ï¼Œè¿™æ¬¡æ”¹ä¸ºä¸€æ¬¡è°ƒç”¨å¾—åˆ°å›å¤ï¼Œåƒè°ƒç”¨è‡ªå·±çš„æ–¹æ³•ä¸€æ ·

    ```java
    package consumer.nio;
    
    import java.io.IOException;
    import java.net.InetSocketAddress;
    import java.nio.ByteBuffer;
    import java.nio.channels.SelectionKey;
    import java.nio.channels.Selector;
    import java.nio.channels.SocketChannel;
    import java.nio.charset.StandardCharsets;
    import java.util.Iterator;
    
    
    //v1.2ç‰ˆæœ¬éé˜»å¡nio   çœŸæ­£æ„ä¹‰ä¸Šå®ç°äº†rpcè°ƒç”¨
    public class NIONonBlockingClient12 {
        public static String start(String HostName, int PORT,String msg) throws IOException{
            return start0(HostName,PORT,msg);
        }
    
        //çœŸæ­£å¯åŠ¨åœ¨è¿™
        private static String start0(String hostName, int port,String msg) throws IOException {
            //å¾—åˆ°ä¸€ä¸ªç½‘ç»œé€šé“
            SocketChannel socketChannel = SocketChannel.open();
            System.out.println("-----------æœåŠ¡æ¶ˆè´¹æ–¹å¯åŠ¨-------------");
            socketChannel.configureBlocking(false);
            //å»ºç«‹é“¾æ¥  éé˜»å¡è¿æ¥  ä½†æˆ‘ä»¬æ˜¯è¦ç­‰ä»–è¿æ¥ä¸Š
            if (!socketChannel.connect(new InetSocketAddress(hostName,port))) {
                while (!socketChannel.finishConnect());
            }
            //åˆ›å»ºé€‰æ‹©å™¨ è¿›è¡Œç›‘å¬è¯»äº‹ä»¶
            Selector selector = Selector.open();
            socketChannel.register(selector, SelectionKey.OP_READ, ByteBuffer.allocate(1024));
    
            //è¿›è¡Œå‘é€ å‘çš„å¤ªå¿«äº† æ¥ä¸åŠæ”¶åˆ°
            socketChannel.write(ByteBuffer.wrap(msg.getBytes(StandardCharsets.UTF_8)));
    
            //ç›´æ¥è¿›è¡Œç›‘å¬
            while (true)
            {
                //æ•è·å¼‚å¸¸  ç›‘å¬è¯»äº‹ä»¶
                try {
                    if (selector.select(1000)==0)
                    {
                        continue;
                    }
                    Iterator<SelectionKey> keyIterator = selector.selectedKeys().iterator();
                    while (keyIterator.hasNext())
                    {
                        SelectionKey key = keyIterator.next();
                        ByteBuffer buffer = (ByteBuffer)key.attachment();
                        SocketChannel channel = (SocketChannel)key.channel();
                        int read = 1;
                        //ç”¨è¿™ä¸ªçš„åŸå› æ˜¯æ€• å¤šçº¿ç¨‹å‡ºç°å½±å“
                        StringBuffer stringBuffer = new StringBuffer();
                        while (read!=0)
                        {
                            buffer.clear();
                            read = channel.read(buffer);
                            stringBuffer.append(new String(buffer.array(),0,read));
                        }
                        return stringBuffer.toString();
                    }
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }
    
    ```

  - å¯åŠ¨ç±»ä»£ç 

    ```java
    package consumer.bootstrap;
    
    
    import consumer.proxy.RpcClientProxy;
    import method.Customer;
    
    
    import java.io.IOException;
    
    /*
        ä»¥nioä¸ºç½‘ç»œç¼–ç¨‹æ¡†æ¶çš„æ¶ˆè´¹è€…ç«¯å¯åŠ¨ç±»
     */
    public class NIOConsumerBootStrap12 {
        public static void main(String[] args) throws IOException {
    
            RpcClientProxy clientProxy = new RpcClientProxy();
            Customer customer = (Customer) clientProxy.getBean(Customer.class);
            String response = customer.hello("success");
            System.out.println(response);
            System.out.println(customer.bye("fail"));
        }
    }
    ```

    

  - **å®ç°æ•ˆæœ**

    ![1651149248676](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\1651149248676.png)

    ![1651149232505](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\1651149232505.png)





































## RPCæ¡†æ¶v2.0nettyç‰ˆ











## é‡åˆ°çš„é—®é¢˜

- @Dataæ³¨è§£åœ¨ç±»ä¸Šæ— æ³•ä½¿ç”¨   `è§£å†³`æˆ‘æŠŠæˆ‘ä¸€äº›æ²¡å¯¼ç‰ˆæœ¬å·çš„ä¾èµ–åŠ ä¸Šç‰ˆæœ¬åæ¢å¤
  
- é¢å¤–å¼€å¯ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œç›‘å¬è¯»äº‹ä»¶  ç¬¬ä¸€æ¬¡å¯ä»¥ç›‘å¬çš„åˆ° åé¢å°±ç›‘å¬ä¸åˆ°äº†     `è§£å†³`è¿­ä»£å™¨iteratorä¸€å®šè¦è®°å¾—removeå¦åˆ™å°±å‡ºé”™äº†
  
- å½“å…³é—­ä¸€ä¸ªå®¢æˆ·ç«¯çš„æ—¶å€™  æœåŠ¡ç«¯ä¹Ÿè‡ªåŠ¨å…³é—­äº†  `è§£å†³` æ›´æ–°v1.1
  
- å½“åˆ©ç”¨ioå¯¹requestå¯¹è±¡è¿›è¡Œä¼ è¾“æ—¶å‡ºç° Exception in thread "main" java.nio.channels.IllegalBlockingModeException     `åŸå› `  å‡å¦‚sockeræ˜¯éé˜»å¡çš„è¯  å¯ä»¥ç”¨selector   ä½†ä¸èƒ½ç”¨ioæµ å› ä¸ºè¿™æ˜¯é˜»å¡ä¼ è¾“æ–¹å¼ã€‚
  
- è¿˜é‡åˆ°äº†åšé˜»å¡å¯åŠ¨çš„æ—¶å€™ï¼Œæˆ‘è·å–äº†ä¸€ä¸ªé€šé“çš„è¾“å…¥æµå’Œè¾“å‡ºæµ ç„¶åå‡ºé—®é¢˜äº†ç›´æ¥æ­»é”åŠ¨å¼¹ä¸å¾— å› ä¸ºä¸€ä¸ªç®¡é“æ˜¯åŠåŒå·¥çš„ æ‰€ä»¥ä¸èƒ½åŒæ—¶è¾“å…¥æµè¾“å‡ºæµè¿›è¡Œè¯»å†™  æˆ‘ç°åœ¨å°è¯•å»ä¿®æ”¹ã€‚ `ä¿®æ”¹æˆåŠŸ`  æˆ‘æŠŠè¾“å…¥æµå’Œè¾“å‡ºæµçš„åˆ›å»ºé¡ºåºå’Œä»–ä»¬çš„ä½¿ç”¨é¡ºåºä¿æŒ ä¸€è‡´å°±æˆåŠŸäº†ï¼Ÿ  ==ç»§ç»­æŸ¥æ‰¾åŸå› ==  [(8æ¡æ¶ˆæ¯) ObjectInputStreamä¸ObjectOutputStreamçš„é¡ºåºé—®é¢˜_åˆ°ä¸­æµéé£èˆŸçš„åšå®¢-CSDNåšå®¢](https://blog.csdn.net/qq_38746380/article/details/102993169)æŸ¥çœ‹è¯¥ç½‘å€ ï¼Œè¯´çš„éå¸¸è¯¦ç»†ï¼ å¦‚æœä¸¤è¾¹åˆ›å»ºçš„éƒ½æ˜¯å…ˆObjectInputStreamä¼šå¯¼è‡´éƒ½é˜»å¡åœ¨é‚£è¾¹ç­‰å¾…è¯»å†™ 

  - ä¸å¤šè¯´ç›´æ¥è¿½æºç 

    ![1651067040657](images/1651067040657.png)

![1651067081930](images/1651067081930.png)

![1651067198890](images/1651067198890.png)

â€‹		ç¬¬ä¸€æ®µçš„æ„æ€æ˜¯ï¼Œåˆ›å»ºä¸€ä¸ªä»æŒ‡å®šçš„InputStreamè¯»å–çš„ObjectInputStreamï¼Œåºåˆ—åŒ–çš„æµçš„å¤´æ˜¯ä»è¿™ä¸ªStreamä¸­è¯»å–å¹¶éªŒè¯çš„ã€‚æ­¤æ„é€ æ–¹æ³•ä¼šä¸€ç›´é˜»å¡ç›´åˆ°ç›¸åº”çš„ObjectOutputStreamå·²ç»å†™å…¥å¹¶åˆ·æ–°å¤´ã€‚

æ‰€ä»¥ä¸Šè¿°ä»£ç æ‰§è¡Œåä¼šéƒ½é˜»å¡ï¼Œå¦‚æœå°†åˆ›å»ºObjectInputStreamçš„é¡ºåºä¿®æ”¹æˆå…¶ä»–çš„é¡ºåºï¼Œä¾¿å¯æ­£å¸¸é€šä¿¡ã€‚


- zookeeperå„ä¸ªç«¯å£çš„ä½œç”¨ï¼š

  2181ï¼šå¯¹å®¢æˆ·ç«¯æä¾›æœåŠ¡
  2888ï¼šFollowerä¸Leaderäº¤æ¢ä¿¡æ¯çš„ç«¯å£ã€‚ 
  3888ï¼šä¸‡ä¸€é›†ç¾¤ä¸­çš„LeaderæœåŠ¡å™¨æŒ‚äº†ï¼Œéœ€è¦ä¸€ä¸ªç«¯å£æ¥é‡æ–°è¿›è¡Œé€‰ä¸¾ï¼Œé€‰å‡ºä¸€ä¸ªæ–°çš„Leaderï¼Œè€Œè¿™ä¸ªç«¯å£å°±æ˜¯ç”¨æ¥æ‰§è¡Œé€‰ä¸¾æ—¶æœåŠ¡å™¨ç›¸äº’é€šä¿¡çš„ç«¯å£ã€‚

- åœ¨è®¾ç½®ä¸linuxä¸­zookeeperè¿æ¥çš„æ—¶å€™  å½“æˆ‘åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Œé€šè¿‡æœåŠ¡å™¨æŸ¥è¯¢ç¬¬ä¸€ä¸‹æŸ¥åˆ°äº†ï¼Œç„¶åé©¬ä¸ŠæŸ¥ä¸åˆ°äº†ï¼Œå°è¯•è§£å†³ã€‚`è§£å†³`æ˜¯æˆ‘ä¹‹å‰å­¦çš„æ²¡æœ‰è®°ç‰¢ ï¼Œå› ä¸ºä¸€æ—¦å®¢æˆ·ç«¯æ–­å¼€è¿æ¥çš„è¯ï¼Œé‚£ä¹ˆä¸´æ—¶èŠ‚ç‚¹ä¹Ÿä¼šæ–­å¼€è¿æ¥ æ‰€ä»¥åˆ›å»ºæŒä¹…èŠ‚ç‚¹ã€‚
  
- zookeeperåˆ›å»ºå¿…é¡»æ˜¯å®ƒçˆ¶èŠ‚ç‚¹è¦å­˜åœ¨æ‰èƒ½è¿›è¡Œåˆ›å»º
  
- Zookeeper ZooDefs.Ids

  **OPEN_ACL_UNSAFE**  **:** å®Œå…¨å¼€æ”¾çš„ACLï¼Œä»»ä½•è¿æ¥çš„å®¢æˆ·ç«¯éƒ½å¯ä»¥æ“ä½œè¯¥å±æ€§znode

  **CREATOR_ALL_ACL :** åªæœ‰åˆ›å»ºè€…æ‰æœ‰ACLæƒé™

  **READ_ACL_UNSAFEï¼š**åªèƒ½è¯»å–ACL

- å½“åˆ›å»ºzkè¿æ¥çš„æ—¶å€™ äº§ç”Ÿäº†ç©ºæŒ‡é’ˆå¼‚å¸¸  æ˜¯å› ä¸ºæ²¡æœ‰æ·»åŠ ç›‘å¬å™¨
  
- åœ¨è®¾ç½®å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯åŠ¨æ—¶ï¼Œå…±åŒæ³¨å†Œåˆ°zkä¸­ï¼Œé‡åˆ°äº†å¤šçº¿ç¨‹é—®é¢˜ 
  `å­˜åœ¨é—®é¢˜` æµ‹è¯•å‡ºç°é—®é¢˜ å¯åŠ¨ä¸¤ä¸ªæœåŠ¡åªæœ‰ä¸€ä¸ªæœåŠ¡çš„æ–¹æ³•æ³¨å†Œè¿›å»äº†ï¼›
  `è§£å†³æ–¹æ³•` å› ä¸ºæˆ‘æ¯ä¸ªæœåŠ¡æä¾›æ–¹åˆ°åé¢éƒ½æ˜¯å¾ªç¯ç€ç›‘å¬ æ‰€ä»¥ç¬¬ä¸€ä¸ªè¿›å»äº†å°±å‡ºä¸æ¥ç«‹åˆ»  å¼€äº†å¤šä¸ªçº¿ç¨‹

  `å­˜åœ¨é—®é¢˜` å°±æ˜¯ä¼šé‡å¤è¿›è¡Œåˆ›å»ºserviceèŠ‚ç‚¹  åº”è¯¥æ˜¯å¼•å…¥äº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜ å°±æ˜¯å•ä¾‹æ¨¡å¼æ‡’æ±‰æ¨¡å¼1ä¸­ç±»ä¼¼çš„é—®é¢˜
  `è§£å†³æ–¹æ³•` å¯¹æ–¹æ³•è¿›è¡ŒåŠ é” ä½¿ç”¨äº†synchronizedé”ï¼Œè¯¥é”jdk1.6ä¹‹åè¿›è¡Œäº†ä¼˜åŒ–å¯ä»¥ä½¿ç”¨ï¼

  `æˆåŠŸè§£å†³`

- è·å–åŠ¨æ€ä»£ç†å¯¹è±¡çš„ä¸‰ä¸ªå‚æ•°è¯¦è§£

  ![1651145201343](C:\Users\asus\AppData\Roaming\Typora\typora-user-images\1651145201343.png)

- githubä¸èƒ½åŒæ—¶ä¸Šä¼ å¤ªå¤šçš„æ–‡ä»¶ï¼é‡è¦

  
  

## æ€»ç»“

è·³è¿‡äº†BIOçš„æ–¹å¼ç›´æ¥è¿›è¡Œäº†NIOçš„ç®€æ˜“RPCçš„è®¾è®¡ï¼Œæ¯”è¾ƒç®€å•ï¼Œè¿˜æœ‰å¾ˆå¤šéœ€è¦è¿›è¡Œå®ç°çš„ä¸œè¥¿ã€‚å½“ç„¶åœ¨æ­è½®å­çš„é€”ä¸­æˆ‘é‡åˆ°äº†å¾ˆå¤šçš„å‘ï¼Œä¸€ç‚¹ç‚¹çš„å¡«ï¼Œæˆ‘è‡ªèº«ä¹Ÿæœ‰äº†å¾ˆå¤§çš„é•¿è¿›ï¼Œå…³äºç½‘ç»œç¼–ç¨‹ï¼Œå…³äºio...æœªå®Œå¾…ç»­...



